<!DOCTYPE html>
<html>
    <head>
        <title>Commlog Viewer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #121212;
                color: #e0e0e0;
                display: flex;
                height: 100vh;
                overflow: hidden;
            }
            #container {
                display: flex;
                width: 100%;
                height: 100%;
            }
            #contact-list {
                width: 350px;
                background-color: #1e1e1e;
                overflow-y: auto;
                border-right: 1px solid #333;
                flex-shrink: 0;
            }
            #contact-list a {
                display: block;
                padding: 15px;
                text-decoration: none;
                color: #e0e0e0;
                border-bottom: 1px solid #222;
            }
            #contact-list a:hover {
                background-color: #2a2a2a;
            }
            #message-pane {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
            }
            #message-header {
                background-color: #1e1e1e;
                padding: 20px;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            #message-header h2 {
                margin: 0;
                font-size: 1.2em;
            }
            #search-box-messages {
                padding: 8px;
                border-radius: 5px;
                border: 1px solid #444;
                background-color: #333;
                color: #e0e0e0;
                width: 250px;
            }
            #messages-container {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                flex-direction: column;
            }
            .message {
                padding: 10px 15px;
                margin-bottom: 10px;
                border-radius: 18px;
                max-width: 60%;
                word-wrap: break-word;
            }
            .sms-received {
                background-color: #333;
                margin-right: auto;
            }
            .sms-sent {
                background-color: #005c4b;
                margin-left: auto;
            }
            .call-incoming {
                background-color: #555;
                margin-right: auto;
            }
            .call-outgoing {
                background-color: #005c4b;
                margin-left: auto;
            }
            .call-missed {
                background-color: #900;
                margin-right: auto;
            }
            .call-rejected {
                background-color: #700;
                margin-right: auto;
            }
            .message-content {
                font-size: 1em;
                margin-bottom: 5px;
            }
            .message-type, .message-date {
                font-size: 0.7em;
                color: #999;
            }
            .message-type {
                font-style: italic;
            }
            .message-date {
                text-align: right;
            }
            .date-divider {
                text-align: center;
                margin: 20px 0;
                font-size: 0.8em;
                color: #888;
                border-bottom: 1px solid #444;
                line-height: 0.1em;
            }
            .date-divider span {
                background: #121212;
                padding: 0 10px;
            }
            #loading-message, #instruction {
                padding: 20px;
                text-align: center;
                font-size: 1.1em;
            }
            .file-input-container {
                padding: 15px;
                border-bottom: 1px solid #222;
                display: flex;
                gap: 1rem;
                align-items: center;
            }
            .file-input-wrapper {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-shrink: 0;
            }
            .file-input {
                display: none;
            }
            .custom-file-upload {
                background-color: #444;
                color: #e0e0e0;
                border: none;
                border-radius: 3px;
                padding: 8px 12px;
                cursor: pointer;
                font-weight: bold;
                font-size: 10pt;
                white-space: nowrap;
            }
            .custom-file-upload:hover {
                background-color: #555;
            }
            .file-input-wrapper:first-child {
                flex-grow: 1;
                white-space: nowrap;
            }
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #1e1e1e;
            }
            ::-webkit-scrollbar-thumb {
                background-color: #555;
                border-radius: 10px;
                border: 2px solid #1e1e1e;
            }
            ::-webkit-scrollbar-thumb:hover {
                background-color: #666;
            }
            #search-box-contacts {
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                border: 1px solid #444;
                background-color: #333;
                color: #e0e0e0;
                font-size: 1em;
                margin-bottom: 10px;
            }
        </style>
    </head>
    <body>

    <div id="container">
        <div id="contact-list">
            <div class="file-input-container">
                <div class="file-input-wrapper">
                    <h2>Commlog Viewer</h2>
                </div>
                <div class="file-input-wrapper">
                    <label for="file-input" class="custom-file-upload" title="Enter XML Backup File">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="--darkreader-inline-stroke: var(--darkreader-text-000000, #e8e6e3);" data-darkreader-inline-stroke=""><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M4 22h14a2 2 0 002-2V7.5L14.5 2H6a2 2 0 00-2 2v4"></path> <path d="M14 2v6h6"></path> <path d="M2 15h10"></path> <path d="M9 18l3-3-3-3"></path> </g></svg>
                    </label>
                    <input type="file" id="file-input" class="file-input">
                </div>
            </div>
            <div style="padding: 10px;">
                <input type="text" id="search-box-contacts" placeholder="Search contacts...">
            </div>
            <div id="contact-list-content">
                <div id="instruction">Please load your XML files.</div>
            </div>
        </div>

        <div id="message-pane">
            <div id="message-header" style="display: none;">
                <h2 id="contact-name"></h2>
                <input type="text" id="search-box-messages" placeholder="Search messages...">
            </div>
            <div id="messages-container">
                <div id="loading-message" style="display: none;">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const svgFavicon = `
            <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                <path d="M16.8 14.5l3.2-3.2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2h2v5l8.7-8.7 2.1 2.2z" />
                <path d="M22.6 11.1l-6.1 6.1-2.1-2.2-1.4 1.4 3.5 3.6 7.5-7.6" />
            </svg>
        `.trim();

        const svgDataUri = 'data:image/svg+xml,' + encodeURIComponent(svgFavicon);
        const link = document.createElement('link');
        link.rel = 'icon';
        link.href = svgDataUri;
        link.type = 'image/svg+xml';

        document.head.appendChild(link);

        document.getElementById('file-input').addEventListener('change', (evt) => handleFileSelect(evt), false);
        document.getElementById('search-box-messages').addEventListener('input', handleMessageSearch, false);
        document.getElementById('search-box-contacts').addEventListener('input', handleContactSearch, false);

        let conversations = {};
        let allEvents = [];

        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        parseXml(e.target.result);
                    } catch (error) {
                        alert(`Error parsing XML file: ` + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function parseXml(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");

            const isSmsFile = xmlDoc.getElementsByTagName('sms').length;
            const fileType = isSmsFile ? 'sms' : 'call';
            const nodes = xmlDoc.getElementsByTagName(fileType);

            if(nodes.length == 0)
                return alert(`File is corrupted!\nMake sure you have the proper backup file.`);

            for (const node of nodes) {
                const event = {
                    type: fileType,
                    data: node,
                    timestamp: parseInt(node.getAttribute('date'))
                };
                allEvents.push(event);
            }

            organizeConversations();
        }

        function organizeConversations() {
            conversations = {};
            const tempConversations = {};

            allEvents.sort((a, b) => b.timestamp - a.timestamp);

            allEvents.forEach(event => {
                const address = event.data.getAttribute(event.type === 'sms' ? 'address': 'number');
                const contactName = event.data.getAttribute('contact_name') && event.data.getAttribute('contact_name') !== "(Unknown)"
                    ? event.data.getAttribute('contact_name')
                    : address;

                if (!tempConversations[contactName])
                    tempConversations[contactName] = { events: [], lastEventDate: 0, address: address };

                tempConversations[contactName].events.push(event);
                if (event.timestamp > tempConversations[contactName].lastEventDate) {
                    tempConversations[contactName].lastEventDate = event.timestamp;
                }
            });

            for(const contact of Object.keys(tempConversations)) {
                conversations[contact] = tempConversations[contact];
            }

            displayContactList();
            if (tempConversations.length > 0) displayMessages(tempConversations[0]);
        }

        function displayContactList() {
            const contactListDiv = document.getElementById('contact-list-content');
            contactListDiv.innerHTML = '';
            const sortedContacts = Object.keys(conversations).sort((a, b) => 
                conversations[b].lastEventDate - conversations[a].lastEventDate
            );

            sortedContacts.forEach(contact => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = contact;
                a.setAttribute('data-address', conversations[contact].address);
                a.onclick = (e) => {
                    e.preventDefault();
                    displayMessages(contact);
                };
                contactListDiv.appendChild(a);
            });
        }

        function displayMessages(contact) {
            currentContact = contact;
            document.getElementById('message-header').style.display = 'flex';
            document.getElementById('contact-name').textContent = `${contact} (${conversations[contact].address})`;

            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';

            const events = conversations[contact].events;
            const sortedEvents = events.sort((a, b) => a.timestamp - b.timestamp);

            let lastDate = null;

            sortedEvents.forEach(event => {
                const readableDateStr = event.data.getAttribute('readable_date');
                const eventDate = new Date(readableDateStr);
                const currentDate = eventDate.toLocaleDateString();

                if (currentDate !== lastDate) {
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    dateDivider.innerHTML = `<span>${currentDate}</span>`;
                    messagesContainer.appendChild(dateDivider);
                    lastDate = currentDate;
                }

                const messageDiv = document.createElement('div');
                let contentHTML = '';
                let messageClass = '';
                let typeText = '';

                if (event.type === 'sms') {
                    const smsType = event.data.getAttribute('type');
                    messageClass = `message sms-${smsType === '1' ? 'received' : 'sent'}`;
                    typeText = smsType === '1' ? 'SMS (Received)' : 'SMS (Sent)';
                    contentHTML = `
                        <div class="message-content">${event.data.getAttribute('body')}</div>
                        <div class="message-type">${typeText}</div>
                    `;
                } else if (event.type === 'call') {
                    const callType = event.data.getAttribute('type');
                    let callTypeDesc;
                    switch(callType) {
                        case '1': messageClass = 'message call-incoming'; callTypeDesc = 'Incoming'; break;
                        case '2': messageClass = 'message call-outgoing'; callTypeDesc = 'Outgoing'; break;
                        case '3': messageClass = 'message call-missed'; callTypeDesc = 'Missed'; break;
                        case '5': messageClass = 'message call-rejected'; callTypeDesc = 'Rejected'; break;
                        default: messageClass = 'message call-incoming'; callTypeDesc = 'Unknown';
                    }

                    const duration = event.data.getAttribute('duration');
                    typeText = `Call (${callTypeDesc})`;
                    contentHTML = `
                        <div class="message-content">${typeText}</div>
                        <div class="message-type">Duration: ${formatDuration(duration)}</div>
                    `;
                }

                messageDiv.className = messageClass;
                messageDiv.innerHTML = `${contentHTML}<div class="message-date">${readableDateStr}</div>`;
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }

        function handleMessageSearch(evt) {
            const searchTerm = evt.target.value.toLowerCase();
            const messagesContainer = document.getElementById('messages-container');
            const messages = messagesContainer.querySelectorAll('.message');

            messages.forEach(message => {
                const details = message.textContent.toLowerCase();
                message.style.display = details.includes(searchTerm) || searchTerm === '' ? 'block' : 'none';
            });

            const dividers = messagesContainer.querySelectorAll('.date-divider');
            dividers.forEach(divider => {
                let hasVisibleMessages = false;
                let nextSibling = divider.nextElementSibling;
                while(nextSibling && !nextSibling.className.includes('date-divider')) {
                    if (nextSibling.style.display !== 'none') {
                        hasVisibleMessages = true;
                        break;
                    }
                    nextSibling = nextSibling.nextElementSibling;
                }
                divider.style.display = hasVisibleMessages ? 'block' : 'none';
            });
        }

        function handleContactSearch(evt) {
            const searchTerm = evt.target.value.toLowerCase();
            const contactListContent = document.getElementById('contact-list-content');
            const contacts = contactListContent.querySelectorAll('a');

            contacts.forEach(contact => {
                const name = contact.textContent.toLowerCase();
                const address = contact.getAttribute('data-address').toLowerCase();
                if (name.includes(searchTerm) || address.includes(searchTerm) || searchTerm === '') {
                    contact.style.display = 'block';
                } else {
                    contact.style.display = 'none';
                }
            });
        }
    </script>

    </body>
</html>
